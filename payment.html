<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ä»˜æ¬¾ | å¸ƒå¶æ—¥å’Œ</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        @font-face { font-family: 'OpenHuninn'; src: url('jf-openhuninn-2.0.ttf') format('truetype'); }
        :root { --color-pink-hot: #ffafcc; --text-color: #5a4a4a; }
        body { font-family: 'OpenHuninn', sans-serif; background-color: #f7e1ea; padding: 20px; color: var(--text-color); }
        .container { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--color-pink-hot); border-bottom: 2px dashed #ddd; padding-bottom: 15px; }
        
        /* æ¸…å–®æ¨£å¼ */
        .list-group { margin-bottom: 20px; border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fffafa; }
        .list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 1rem; }
        .list-item:last-child { border-bottom: none; }
        .item-name { font-weight: bold; }
        .item-sub { font-size: 0.85rem; color: #888; margin-top: 4px; }
        
        .total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.3rem; margin-top: 15px; color: var(--color-pink-hot); border-top: 2px solid #eee; padding-top: 15px; }
        .btn { background: var(--color-pink-hot); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; font-weight: bold; }
        
        .empty-msg { text-align: center; color: #888; margin: 30px 0; }
        
        /* å‚™è¨»æ¡†æ¨£å¼ */
        .note-area { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-family: 'OpenHuninn', sans-serif; font-size: 1rem; box-sizing: border-box; resize: vertical; background: #fdfdfd; }
        .note-area:focus { outline: none; border-color: var(--color-pink-hot); background: white; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ’³ çµå¸³ä»˜æ¬¾</h2>
        
        <div id="orderContent">
            </div>

        <div id="paymentSection" style="display:none;">
            <div style="margin: 20px 0;">
                <label style="font-weight:bold; display:block; margin-bottom:8px;">è¨‚å–®å‚™è¨» / è‰²è™ŸæŒ‡å®š</label>
                <textarea id="orderNote" rows="3" class="note-area" placeholder="ä¾‹å¦‚ï¼šçµ¨å¸ƒè¦ç´…è‰²ã€æ¶ˆè‰²ç­†è¦è—è‰²..."></textarea>
            </div>

            <h3>é¸æ“‡ä»˜æ¬¾æ–¹å¼</h3>
            <label style="display:block; margin:10px 0; cursor:pointer;"><input type="radio" name="pay" checked> ä¿¡ç”¨å¡ (Visa/Master)</label>
            <label style="display:block; margin:10px 0; cursor:pointer;"><input type="radio" name="pay"> éŠ€è¡Œè½‰å¸³ / ATM</label>

            <button class="btn" onclick="processPayment()">ç¢ºèªæ”¯ä»˜ NT$ <span id="btnAmount">0</span></button>
        </div>
        
        <div style="text-align: center; margin-top: 15px;"><a href="index.html" style="color:#999; text-decoration:none;">å–æ¶ˆ</a></div>
    </div>

    <script>
        const shopCart = JSON.parse(localStorage.getItem('shopCart'));
        const bookingData = JSON.parse(localStorage.getItem('bookingData'));
        const contentDiv = document.getElementById('orderContent');
        const paymentSection = document.getElementById('paymentSection');
        const noteInput = document.getElementById('orderNote');
        
        let total = 0;
        let html = '';
        let finalItems = []; 

        // 1. æª¢æŸ¥æ˜¯å¦æœ‰é ç´„è³‡æ–™
        if (bookingData && bookingData.price > 0) {
            html += `<h4 style="margin:0 0 10px 0; color:#555;">ğŸ“… é ç´„è¨‚é‡‘</h4><div class="list-group">`;
            html += `
                <div class="list-item">
                    <div>
                        <div class="item-name">${bookingData.name}</div>
                        <div class="item-sub">é ç´„äºº: ${bookingData.user} / æ—¥æœŸ: ${bookingData.date}</div>
                    </div>
                    <span>$${bookingData.price}</span>
                </div>`;
            html += `</div>`;
            total += bookingData.price;
            finalItems.push({ name: `[é ç´„] ${bookingData.name}`, price: bookingData.price });
            
            // å¦‚æœé ç´„æ™‚æœ‰å¡«å¯«å‚™è¨»ï¼Œè‡ªå‹•å¸¶å…¥å‚™è¨»æ¡†
            if(bookingData.note) {
                noteInput.value = bookingData.note;
            }
        }

        // 2. æª¢æŸ¥æ˜¯å¦æœ‰è³¼ç‰©è»Šè³‡æ–™
        if (shopCart && shopCart.length > 0) {
            html += `<h4 style="margin:15px 0 10px 0; color:#555;">ğŸ›ï¸ è³¼è²·å•†å“</h4><div class="list-group">`;
            shopCart.forEach(item => {
                let subTotal = item.price * item.qty;
                html += `
                    <div class="list-item">
                        <div>
                            <div class="item-name">${item.name} x ${item.qty}</div>
                            <div class="item-sub">${item.option}</div>
                        </div>
                        <span>$${subTotal}</span>
                    </div>`;
                total += subTotal;
                finalItems.push({ name: `${item.name} (${item.option}) x${item.qty}`, price: subTotal });
            });
            html += `</div>`;
        }

        // 3. æ¸²æŸ“é é¢
        if (total === 0) {
            html = '<div class="empty-msg">ç›®å‰æ²’æœ‰å¾…ä»˜æ¬¾çš„é …ç›®<br><a href="shop.html" style="color:var(--color-pink-hot);">å»å•†åŸé€›é€›ï¼Ÿ</a></div>';
        } else {
            html += `<div class="total-row"><span>ç¸½é‡‘é¡</span><span>NT$ ${total}</span></div>`;
            paymentSection.style.display = 'block'; 
        }

        contentDiv.innerHTML = html;
        document.getElementById('btnAmount').innerText = total;

        // 4. ä»˜æ¬¾è™•ç†
        function processPayment() {
            let type = 'shop';
            if (bookingData && shopCart) type = 'mixed';
            else if (bookingData) type = 'booking';

            const contactEmail = bookingData ? bookingData.email : "æœªæä¾›(è³¼ç‰©)";
            const bookingDate = bookingData ? bookingData.date : null;
            
            // â˜… æŠ“å–ä½¿ç”¨è€…å¡«å¯«çš„å‚™è¨»
            const userNote = document.getElementById('orderNote').value;

            const orderRecord = {
                type: type,
                isBooking: !!bookingData,
                bookingDate: bookingDate,
                contactEmail: contactEmail,
                items: finalItems,
                total: total,
                note: userNote, // â˜… å­˜å…¥å‚™è¨»
                date: new Date().toLocaleString()
            };
            localStorage.setItem('lastOrder', JSON.stringify(orderRecord));
            
            localStorage.removeItem('shopCart');
            localStorage.removeItem('bookingData');
            
            window.location.href = "success.html";
        }
    </script>
</body>
</html>